# +
# -*- coding: utf-8 -*-
# Copyright (c) Meta Platforms, Inc. and affiliates.
#
# pytx documentation build configuration file, created by
# Author:Yang Zhang
# date:2024.3.28
# Institute:JSPI


import os
import numpy as np
import pandas as pd
import more_itertools


# -

#字节码统计
class SmaliModule:
    def __init__(self,path,target=None,is_one_file=True,**kwargs):
        self.p=path #起始文件路径
        self.d=target #目标文件路径
        self.oneflag=is_one_file #判断是否为单个文件
        self.codes=[] #存储字节码列表
        
        #读取字节码数据库并添加到列表中
        with open(r'code.txt', 'r') as f:
            self.codes = f.readlines()
            for i in range(len(self.codes)):
                self.codes[i]=self.codes[i].rstrip('\n')
        self.count={}

        self.smali_ls=[]
        self.smali_ls_raw = os.listdir(self.p)
        for li in self.smali_ls_raw:
            if "smali" in str(li):
                self.smali_ls.append(li)
        for i in range(len(self.smali_ls)):
            self.smali_ls[i] = self.p+"\\"+self.smali_ls[i]

        self.file_ls = []
        for li in self.smali_ls:
            for root, dirs, files in os.walk(li):
                root_file_ls = [os.path.join(root, file) for file in files]
                self.file_ls.append(root_file_ls)
        self.file_ls=list(more_itertools.collapse(self.file_ls))

    #每个文件中字节码数量统计
    def __count(self):
        for path in self.file_ls:
            with open(path,'r', encoding='utf-8') as file_object:
                contets = file_object.read()
                for code in self.codes:
                    index=contets.count(code)
                    if index!=0:
                        if code in self.count:
                            self.count[code]=index+self.count[code]
                        else:
                            self.count[code]=index
        print(self.count)

    def run(self):
        self.__count()


test=SmaliModule(r'C:\Users\Zy187\Desktop\24.3大创\None')

test.run()
