import numpy as np
import pandas as pd
from bs4 import BeautifulSoup
import requests
import matplotlib.pyplot as plt
import os
import sys
import time
import xml.etree.ElementTree as ET
import xml.sax
from xml.dom.minidom import parse
import re


class DOMReader:
    def __init__(self,PathList,parameters=None):
        self.PathList=PathList
        self.PermissionList=[]
        self.namespace = '{http://schemas.android.com/apk/res/android}'
        self.parameters=parameters
        if self.parameters==None:
            self.parameters=['uses-permission','permission','activity','receiver','service','provider']
        self.ActionList,self.ActivityList=[],[]
        
    def read(self,file,Tag):
        dom=ET.parse(file)
        root=dom.getroot()
        #print(root.find('application').findall('activity'))
        for tag in Tag:
            if tag=='uses-permission' or tag=='permission':
                for child in root.findall(tag):
                    childName = child.get(self.namespace+'name')
                    self.PermissionList.append(childName)
                    #print(childName)

            elif tag=='intent-filter':
                for child in root.findall(tag):
                    for action in child.findall('action'):
                        actionname=action.get(self.namespace+'name')
                        self.ActionList.append(actionname)
                    for category in child.findall('category'):
                        categoryname=category.get(self.namespace+'name')
                        self.ActionList.append(categoryname)

            elif tag in ['activity','receiver','service','provider']:
                app=root.find('application')
                for child in app.findall(tag):
                    childName = child.get(self.namespace+'name')
                    self.ActivityList.append(childName)
                    if child.find('intent-filter'):
                        intent=child.find('intent-filter')
                        for action in intent.findall('action'):
                            actionname=action.get(self.namespace+'name')
                            self.ActionList.append(actionname)

                        for category in intent.findall('category'):
                            categoryname=category.get(self.namespace+'name')
                            self.ActionList.append(categoryname)
                        
    def forward(self):
        PathList=self.PathList
        for file in PathList:
            self.read(file,self.parameters)
        
    def run(self):
        self.forward()
        self.DeleteDuplicate()
        return self.PermissionList,self.ActionList,self.ActivityList
    
    def DeleteDuplicate(self):
        self.PermissionList=list(set(self.PermissionList))
        self.ActionList,self.ActivityList=list(set(self.ActionList)),list(set(self.ActivityList))


model=DOMReader([r"D:\Downloads\APK分析工具\7.案例\cmx\AndroidManifest.xml",r"D:\Downloads\APK分析工具\7.案例\样本2\AndroidManifest.xml"])
print(model.run())


